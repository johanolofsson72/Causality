# ADR-0004: Projection-First Query Execution

## Context
Entity Framework Core allows returning entire entity objects directly to the client.  
However, doing so introduces several problems:
- **Security**: Entities may contain sensitive fields that should never leave the server.
- **Stability**: Schema changes (e.g., new columns) would automatically leak into the API.
- **Performance**: Returning entire entities increases payload size and serialization cost.
- **Compliance**: GDPR requires strict control over which fields are exposed.

To ensure safety and maintainability, queries must always project into Data Transfer Objects (DTOs) before materialization.

---

## Decision
We adopt a **Projection-First approach**:

- Every entity must have one or more DTOs defined in `Shared/DTOs/`.
- The **Query Translator** must always apply a `Select` expression mapping entities → DTOs.
- DTOs are the **only types returned** in API responses.
- Projection maps must be explicit and centrally defined (manual or via AutoMapper with profiles).
- The `select` clause in Abstract Query (AQ) is validated against the allowed DTO fields.

---

## Consequences
- **Security**: Only whitelisted fields in DTOs can ever be returned.
- **Stability**: Database schema changes do not leak into API.
- **Performance**: Smaller payloads, reduced serialization overhead.
- **Flexibility**: Different DTOs can be defined for different use-cases (list vs details).
- **Effort**: Requires maintenance of DTO definitions and projection maps.

---

## Status
Accepted – all query results must use explicit DTO projection.
