# ADR-0001: Client-to-Server LINQ Serialization

## Context
Causality is designed to let clients construct queries in Blazor and send them to the server for execution.  
A naïve approach would be to serialize raw LINQ expression trees or C# code and send them directly.  
However, this poses multiple issues:
- **Security**: Arbitrary expressions could expose sensitive data, execute unintended methods, or cause denial-of-service.
- **Interoperability**: Raw expressions are tightly coupled to .NET and difficult to version or extend.
- **Maintainability**: Expression trees may change between .NET versions, breaking compatibility.
- **Auditability**: Raw expressions are hard to log, validate, and reason about.

We need a safer, language-agnostic format that can evolve over time while ensuring predictable behavior.

---

## Decision
We will **not transmit raw LINQ or Expression Trees** from client to server.  
Instead, we introduce an **Abstract Query (AQ) Contract** defined in `docs/QUERY-CONTRACT.md`.  

- The client uses **QueryBuilder** or ExpressionSerializer v2 to produce AQ JSON.  
- AQ contains only allowed operators (eq, neq, lt, gt, contains, etc.), sort definitions, projection fields, and paging.  
- The server validates AQ against a whitelist of allowed entities, fields, and operators.  
- The server then **translates AQ → IQueryable<TEntity>** with injected tenant filters and projects to DTOs.  
- The AQ format is **versioned** (v1, v2, …) to allow future evolution.

---

## Consequences
- **Security**: No arbitrary expressions. Queries must conform to the AQ schema and validation rules.  
- **Predictability**: Queries are limited to a controlled operator set.  
- **Extensibility**: We can evolve AQ by adding new operators or fields without breaking existing clients.  
- **Auditability**: AQ can be logged and hashed for caching, monitoring, and compliance.  
- **Interoperability**: Other clients (non-.NET) can build and send AQ JSON as well.  

---

## Status
Accepted – baseline for all query communication between client and server.
