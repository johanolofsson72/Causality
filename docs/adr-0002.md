# ADR-0002: Query Guardrails

## Context
Allowing clients to define and execute queries against the server database introduces risks:
- **Performance**: Unbounded queries may scan millions of rows or perform expensive joins.
- **Security**: Malicious users could attempt to access data they should not see.
- **Stability**: Complex expressions or nested filters could overload EF Core or the database.
- **Compliance**: GDPR and internal policies require strict control over which fields can be queried and how data is accessed.

To mitigate these risks, the system must enforce strict guardrails on every query before execution.

---

## Decision
We introduce a **validation and guardrail layer** that checks all incoming Abstract Queries (AQ) against predefined limits before translation and execution.  

The guardrails include:  
- **AllowedMembers / AllowedMethods**  
  - Only explicitly whitelisted fields and operators (eq, neq, lt, gt, contains, etc.) can be used.  
  - Non-whitelisted fields or methods cause rejection.  

- **Depth & Size Limits**  
  - `MaxDepth` – maximum nesting level of filters (default: 4).  
  - `MaxNodes` – maximum number of filter nodes in a single query (default: 200).  
  - `MaxPageSize` – maximum number of results per page (default: 200).  

- **Execution Timeout**  
  - Each query runs with a cancellation token and must complete within a configured timeout (e.g., 5 seconds).  

- **Projection Whitelist**  
  - Clients may only request fields defined in projection maps (DTOs).  
  - Direct entity exposure is forbidden.  

- **Mandatory Filters**  
  - Tenant ID and RBAC predicates are always injected server-side.  
  - These cannot be overridden by the client.  

- **Audit Logging**  
  - Every query is logged with hash, user, entity, elapsed time, and validation outcome.  
  - Blocked queries are logged with reason codes.  

---

## Consequences
- **Improved security**: Queries cannot escape the defined whitelist.  
- **Stable performance**: Guardrails prevent runaway queries or excessive result sets.  
- **Predictability**: Developers know exactly what query shapes are supported.  
- **Compliance**: Audit trail ensures traceability for GDPR and internal governance.  
- **Extra effort**: New features must update whitelist/config to expose additional fields or operators.  

---

## Status
Accepted – all query execution must pass through guardrail validation.
