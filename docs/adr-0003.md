# ADR-0003: Multi-Tenant Filter Injection

## Context
Causality is intended to serve multiple tenants and user roles.  
If the client is allowed to define queries freely, there is a risk that:
- A user could query entities outside their tenant (data leakage).
- RBAC (role-based access control) is bypassed.
- Compliance with GDPR and data protection regulations is broken.

It is not safe to rely on the client to include TenantId or RBAC constraints.  
These filters must be enforced by the server.

---

## Decision
The server will **always inject mandatory filters** into the query pipeline before execution:

- **Tenant filter**: `Entity.TenantId == User.TenantId`  
- **RBAC filter**: expression enforcing user’s roles and permissions on the given entity/fields.  
- **Soft-delete filter**: optionally `Entity.IsDeleted == false` if supported.  

Implementation details:
- Injection happens **after validation** but **before translation to IQueryable**.  
- Clients cannot override or remove these filters.  
- Filters are stored in a centralized service (`TenantFilterService`) and applied consistently across all entities.  
- Unit tests must verify that every query includes the tenant filter.

---

## Consequences
- **Security**: Queries are always scoped to the current tenant and user permissions.  
- **Predictability**: Developers don’t need to remember to add tenant filters manually.  
- **Compliance**: Prevents cross-tenant data leakage.  
- **Overhead**: Slight additional cost in query translation, but necessary for safety.  

---

## Status
Accepted – mandatory for all query execution.
